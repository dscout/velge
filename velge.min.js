!function(a,b){"object"==typeof exports?module.exports=b(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],b):a.Velge=b(a.jQuery)}(this,function(a){return function(){this.Velge=function(){function a(b,c){this.options=null!=c?c:{},this.store=new a.Store(this.options),this.ui=new a.UI(b,this,this.store,this.options),this.addCallbacks=[],this.remCallbacks=[],this._preloadChoices(this.options.chosen||[],!0),this._preloadChoices(this.options.choices||[],!1)}return a.VERSION="0.9.3",a.prototype.setup=function(){return this.ui.setup(),this},a.prototype.setOptions=function(a){var b,c,d;d=[];for(b in a)c=a[b],d.push(this.options[b]=c);return d},a.prototype.addChoice=function(a){return this.store.push(a),this.ui.renderChoices(),this},a.prototype.remChoice=function(a){return this.store["delete"](a),this.ui.renderChoices(),this},a.prototype.addChosen=function(a){var b;return this._enforceSingleChoice(),b=this.store.find(a)||a,b.chosen=!0,this.store.push(b),this.ui.renderChosen(),this.ui.renderChoices(),this._applyCallbacks(b,this.addCallbacks),this},a.prototype.remChosen=function(a){return this.store.update(a,{chosen:!1}),this.ui.renderChosen(),this.ui.renderChoices(),this._applyCallbacks(a,this.remCallbacks),this},a.prototype.getChoices=function(){return this.store.choices()},a.prototype.getChosen=function(){return this.store.filter({chosen:!0})},a.prototype.onAdd=function(a,b){return this.addCallbacks.push({callback:a,context:b}),this},a.prototype.onRem=function(a,b){return this.remCallbacks.push({callback:a,context:b}),this},a.prototype._enforceSingleChoice=function(){var a,b,c,d,e;if(null!=this.options.single){for(d=this.store.choices(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.store.update(a,{chosen:!1}));return e}},a.prototype._preloadChoices=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],null!=c&&(c.chosen=b,f.push(this.store.push(c)));return f},a.prototype._applyCallbacks=function(a,b){var c,d,e,f,g,h;for(h=[],f=0,g=b.length;g>f;f++)c=b[f],d=c.callback,e=c.context||this,h.push(d.call(e,a,this));return h},a}(),Velge.Util={autoScroll:function(a,b,c){var d,e,f,g,h;return null==c&&(c=10),f=a.height(),e=b.height(),g=a.offset().top-b.offset().top,h=b.scrollTop(),d=h+g+c,0>g?b.scrollTop(d):g+(f>e)?b.scrollTop(d-e+f):void 0},cycle:function(a,b,c){return null==c&&(c="down"),b>0?"down"===c?(a+1)%b:(a+(b-1))%b:-1},defaults:function(a,b){var c,d;for(c in b)d=b[c],null==a[c]&&(a[c]=b[c]);return a},emphasize:function(a,b){return null!=b&&b.length>0?a.replace(new RegExp("("+b+")","i"),"<b>$1</b>"):a},template:function(a,b){var c,d,e;c=a;for(d in b)e=b[d],c=c.replace("{{"+d+"}}",e);return c}},Velge.UI=function(){function b(a,b,c,d){null==d&&(d={}),this.$container=a,this.velge=b,this.store=c,this.choiceIndex=-1,this.chosenIndex=-1,this.options=Velge.Util.defaults(d,this.defaults)}return b.prototype.KEYCODES={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188},b.prototype.wrapTemplate="<div class='velge'>\n  <div class='velge-inner'>\n    <ul class='velge-list'></ul>\n    <input type='text' autocomplete='off' placeholder='{{placeholder}}' class='velge-input' />\n    <span class='velge-trigger'></span>\n  </div>\n  <ol class='velge-dropdown'></ol>\n</div>",b.prototype.chosenTemplate="<li>\n  <span class='name'>{{name}}</span>\n  <span class='remove'>&times;</span>\n</li>",b.prototype.choiceTemplate="<li>{{name}}</li>",b.prototype.defaults={placeholder:"Add Tag"},b.prototype.setup=function(){return this.render(),this.bindDomEvents(),this.renderChoices(),this.renderChosen(),this},b.prototype.bindDomEvents=function(){var b,c;return b=this.KEYCODES,c=this,this.$wrapper.on("keydown.velge",".velge-input",function(a){var d;switch(d=function(){return c.choiceIndex=-1,c.filterChoices(c.$input.val())},a.which){case b.ESCAPE:return a.stopPropagation(),c.blurInput(),c.closeDropdown(),c.renderHighlightedChosen(),c.renderChoices(),c.clearInput();case b.COMMA:case b.ENTER:return a.preventDefault(),c.submit(c.$input.val()),c.clearInput(),c.closeDropdown();case b.DOWN:case b.TAB:return a.preventDefault(),c.openDropdown(),c.cycleChoice("down"),c.renderHighlightedChoice(),c.autoComplete();case b.UP:return a.preventDefault(),c.openDropdown(),c.cycleChoice("up"),c.renderHighlightedChoice(),c.autoComplete();case b.LEFT:if(a.stopPropagation(),""===c.$input.val())return-1===c.chosenIndex&&(c.chosenIndex=0),c.cycleChosen("up"),c.renderHighlightedChosen();break;case b.RIGHT:if(a.stopPropagation(),""===c.$input.val())return-1===c.chosenIndex&&(c.chosenIndex=0),c.cycleChosen("down"),c.renderHighlightedChosen();break;case b.BACKSPACE:return""===c.$input.val()?c.chosenIndex>-1?c.removeHighlightedChosen():(c.chosenIndex=0,c.cycleChosen("up"),c.renderHighlightedChosen()):setTimeout(d,10);default:return setTimeout(d,10)}}),this.$wrapper.on("blur.velge",".velge-input",function(){var a;return clearTimeout(c.closeTimeout),a=function(){return c.closeDropdown(),c.clearInput()},c.closeTimeout=setTimeout(a,150)}),this.$wrapper.on("click.velge",function(){return c.$input.is(":focus")||c.$input.focus(),!1}),this.$wrapper.on("click.velge",".velge-list .remove",function(b){var d;return d=a(b.currentTarget).parent().find(".name"),c.velge.remChosen({name:d.text()}),!1}),this.$wrapper.on("click.velge",".velge-trigger",function(){return clearTimeout(c.closeTimeout),c.toggleDropdown(),!1}),this.$wrapper.on("click.velge",".velge-dropdown li",function(b){var d;return d=a(b.currentTarget),c.submit(d.text()),c.renderChoices(),c.renderChosen(),c.closeDropdown(),!1}),this.$input.on("focus",this.options.onFocus),this.$input.on("blur",this.options.onBlur)},b.prototype.submit=function(a){return this.store.isValid(a)?this.velge.addChosen({name:a}):!1},b.prototype.render=function(){return this.$wrapper=a(Velge.Util.template(this.wrapTemplate,this.options)),this.$inner=a(".velge-inner",this.$wrapper),this.$list=a(".velge-list",this.$wrapper),this.$input=a(".velge-input",this.$wrapper),this.$dropdown=a(".velge-dropdown",this.$wrapper),this.$container.append(this.$wrapper)},b.prototype.renderChosen=function(){var a,b;return b=function(){var b,c,d,e;for(d=this.store.filter({chosen:!0}),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(Velge.Util.template(this.chosenTemplate,{name:a.name}));return e}.call(this),this.$list.html(b)},b.prototype.renderChoices=function(a,b){var c,d;return a||(a=this.store.filter({chosen:!1})),d=function(){var d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(Velge.Util.template(this.choiceTemplate,{name:Velge.Util.emphasize(c.name,b)}));return f}.call(this),this.$dropdown.html(d)},b.prototype.renderHighlightedChoice=function(){var b,c,d,e,f,g,h,i;for(e=this.choiceIndex,h=this.$dropdown.find("li"),i=[],c=f=0,g=h.length;g>f;c=++f)d=h[c],b=a(d),b.toggleClass("highlighted",c===e),i.push(c===e?Velge.Util.autoScroll(b,this.$dropdown):void 0);return i},b.prototype.renderHighlightedChosen=function(){var b,c,d,e,f,g,h;for(d=this.chosenIndex,g=this.$list.find("li"),h=[],b=e=0,f=g.length;f>e;b=++e)c=g[b],h.push(a(c).toggleClass("highlighted",b===d));return h},b.prototype.removeHighlightedChosen=function(){var a;return a=this.$list.find(".highlighted .name"),this.velge.remChosen({name:a.text()}),this.positionDropdown(this.options.dropdownOffset),this.chosenIndex=-1},b.prototype.cycleChoice=function(a){var b;return b=this.$dropdown.find("li").length,this.choiceIndex=Velge.Util.cycle(this.choiceIndex,b,a)},b.prototype.cycleChosen=function(a){var b;return b=this.$list.find("li").length,this.chosenIndex=Velge.Util.cycle(this.chosenIndex,b,a)},b.prototype.openDropdown=function(){return this.store.isEmpty()?void 0:(this.positionDropdown(this.options.dropdownOffset),this.$dropdown.addClass("open"))},b.prototype.positionDropdown=function(b){var c;return null==b&&(b=13),c=a(".velge-trigger",this.$container),this.$dropdown.css({top:c.outerHeight()+b})},b.prototype.closeDropdown=function(){return this.$dropdown.removeClass("open"),this.choiceIndex=-1,this.chosenIndex=-1},b.prototype.toggleDropdown=function(){return this.$dropdown.hasClass("open")?this.closeDropdown():this.openDropdown()},b.prototype.blurInput=function(){return""===this.$input.val()&&-1===this.choiceIndex&&-1===this.chosenIndex?this.$input.blur():void 0},b.prototype.clearInput=function(){return this.$input.val("")},b.prototype.filterChoices=function(a){var b;return b=this.store.fuzzy(a),this.renderChoices(b,a),0!==b.length?this.openDropdown():this.closeDropdown()},b.prototype.autoComplete=function(){var a;return a=this.$dropdown.find(".highlighted"),this.$input.val(a.text())},b}(),Velge.Store=function(){function a(a){null==a&&(a={}),this.arr=[],this.map={},this.options=Velge.Util.defaults(a,this.defaults)}return a.prototype.defaults={autoSort:!0},a.prototype.choices=function(){return this.arr},a.prototype.isEmpty=function(){return 0===this.arr.length},a.prototype.isValid=function(a){return!/^\s*$/.test(a)},a.prototype.push=function(a){return a.name=this._normalize(a.name),a.chosen||(a.chosen=!1),null==this.find(a)&&(this.arr.push(a),this.map[a.name]=a),this.options.autoSort&&this._sort(),this},a.prototype["delete"]=function(a){var b,c,d,e,f;for(f=this.arr,c=d=0,e=f.length;e>d;c=++d)if(b=f[c],b.name===a.name){this.arr.splice(c,1);break}return delete this.map[a.name]},a.prototype.update=function(a,b){var c,d,e,f;c=this.find(a),f=[];for(d in b)e=b[d],f.push(c[d]=e);return f},a.prototype.find=function(a){return this.map[this._normalize(a.name)]},a.prototype.fuzzy=function(a){var b,c,d,e,f,g,h;for(a=this._sanitize(a),c=/^\s*$/.test(a)?".*":a,d=RegExp(c,"i"),g=this.arr,h=[],e=0,f=g.length;f>e;e++)b=g[e],!b.chosen&&d.test(b.name)&&h.push(b);return h},a.prototype.filter=function(a){var b,c,d,e,f,g;for(c=a.chosen,c||(c=!1),f=this.arr,g=[],d=0,e=f.length;e>d;d++)b=f[d],b.chosen===c&&g.push(b);return g},a.prototype._normalize=function(a){return String(a).toLowerCase().replace(/(^\s*|\s*$)/g,"")},a.prototype._sanitize=function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&")},a.prototype._sort=function(){return this.arr.sort(function(a,b){return a.name>b.name?1:-1})},a}()}.call(this),Velge});