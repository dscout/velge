(function(){window.Velge=function(){function a(b,c){this.options=null!=c?c:{},this.store=new a.Store(this.options),this.ui=new a.UI(b,this,this.store,this.options),this.addCallbacks=[],this.remCallbacks=[],this._preloadChoices(this.options.chosen||[],!0),this._preloadChoices(this.options.choices||[],!1)}return a.VERSION="0.9.3",a.prototype.setup=function(){return this.ui.setup(),this},a.prototype.setOptions=function(a){var b,c,d;d=[];for(b in a)c=a[b],d.push(this.options[b]=c);return d},a.prototype.addChoice=function(a){return this.store.push(a),this.ui.renderChoices(),this},a.prototype.remChoice=function(a){return this.store["delete"](a),this.ui.renderChoices(),this},a.prototype.addChosen=function(a){var b;return this._enforceSingleChoice(),b=this.store.find(a)||a,b.chosen=!0,this.store.push(b),this.ui.renderChosen(),this.ui.renderChoices(),this._applyCallbacks(b,this.addCallbacks),this},a.prototype.remChosen=function(a){return this.store.update(a,{chosen:!1}),this.ui.renderChosen(),this.ui.renderChoices(),this._applyCallbacks(a,this.remCallbacks),this},a.prototype.getChoices=function(){return this.store.choices()},a.prototype.getChosen=function(){return this.store.filter({chosen:!0})},a.prototype.onAdd=function(a,b){return this.addCallbacks.push({callback:a,context:b}),this},a.prototype.onRem=function(a,b){return this.remCallbacks.push({callback:a,context:b}),this},a.prototype._enforceSingleChoice=function(){var a,b,c,d,e;if(null!=this.options.single){for(d=this.store.choices(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.store.update(a,{chosen:!1}));return e}},a.prototype._preloadChoices=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],null!=c&&(c.chosen=b,f.push(this.store.push(c)));return f},a.prototype._applyCallbacks=function(a,b){var c,d,e,f,g,h;for(h=[],f=0,g=b.length;g>f;f++)c=b[f],d=c.callback,e=c.context||this,h.push(d.call(e,a,this));return h},a}(),Velge.Util={autoScroll:function(a,b,c){var d,e,f,g,h;return null==c&&(c=10),f=a.height(),e=b.height(),g=a.offset().top-b.offset().top,h=b.scrollTop(),d=h+g+c,0>g?b.scrollTop(d):g+(f>e)?b.scrollTop(d-e+f):void 0},cycle:function(a,b,c){return null==c&&(c="down"),b>0?"down"===c?(a+1)%b:(a+(b-1))%b:-1},defaults:function(a,b){var c,d;for(c in b)d=b[c],null==a[c]&&(a[c]=b[c]);return a},emphasize:function(a,b){return null!=b&&b.length>0?a.replace(new RegExp("("+b+")","i"),"<b>$1</b>"):a},template:function(a,b){var c,d,e;c=a;for(d in b)e=b[d],c=c.replace("{{"+d+"}}",e);return c}},Velge.UI=function(){function a(a,b,c,d){null==d&&(d={}),this.$container=a,this.velge=b,this.store=c,this.choiceIndex=-1,this.chosenIndex=-1,this.options=Velge.Util.defaults(d,this.defaults)}return a.prototype.KEYCODES={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188},a.prototype.wrapTemplate="<div class='velge'>\n  <div class='velge-inner'>\n    <ul class='velge-list'></ul>\n    <input type='text' autocomplete='off' placeholder='{{placeholder}}' class='velge-input' />\n    <span class='velge-trigger'></span>\n  </div>\n  <ol class='velge-dropdown'></ol>\n</div>",a.prototype.chosenTemplate="<li>\n  <span class='name'>{{name}}</span>\n  <span class='remove'>&times;</span>\n</li>",a.prototype.choiceTemplate="<li>{{name}}</li>",a.prototype.defaults={placeholder:"Add Tag"},a.prototype.setup=function(){return this.render(),this.bindDomEvents(),this.renderChoices(),this.renderChosen(),this},a.prototype.bindDomEvents=function(){var a,b;return a=this.KEYCODES,b=this,this.$wrapper.on("keydown.velge",".velge-input",function(c){var d;switch(d=function(){return b.choiceIndex=-1,b.filterChoices(b.$input.val())},c.which){case a.ESCAPE:return c.stopPropagation(),b.blurInput(),b.closeDropdown(),b.renderHighlightedChosen(),b.renderChoices(),b.clearInput();case a.COMMA:case a.ENTER:return c.preventDefault(),b.submit(b.$input.val()),b.clearInput(),b.closeDropdown();case a.DOWN:case a.TAB:return c.preventDefault(),b.openDropdown(),b.cycleChoice("down"),b.renderHighlightedChoice(),b.autoComplete();case a.UP:return c.preventDefault(),b.openDropdown(),b.cycleChoice("up"),b.renderHighlightedChoice(),b.autoComplete();case a.LEFT:if(c.stopPropagation(),""===b.$input.val())return-1===b.chosenIndex&&(b.chosenIndex=0),b.cycleChosen("up"),b.renderHighlightedChosen();break;case a.RIGHT:if(c.stopPropagation(),""===b.$input.val())return-1===b.chosenIndex&&(b.chosenIndex=0),b.cycleChosen("down"),b.renderHighlightedChosen();break;case a.BACKSPACE:return""===b.$input.val()?b.chosenIndex>-1?b.removeHighlightedChosen():(b.chosenIndex=0,b.cycleChosen("up"),b.renderHighlightedChosen()):setTimeout(d,10);default:return setTimeout(d,10)}}),this.$wrapper.on("blur.velge",".velge-input",function(){var a;return clearTimeout(b.closeTimeout),a=function(){return b.closeDropdown(),b.clearInput()},b.closeTimeout=setTimeout(a,150)}),this.$wrapper.on("click.velge",function(){return b.$input.is(":focus")||b.$input.focus(),!1}),this.$wrapper.on("click.velge",".velge-list .remove",function(a){var c;return c=$(a.currentTarget).parent().find(".name"),b.velge.remChosen({name:c.text()}),!1}),this.$wrapper.on("click.velge",".velge-trigger",function(){return clearTimeout(b.closeTimeout),b.toggleDropdown(),!1}),this.$wrapper.on("click.velge",".velge-dropdown li",function(a){var c;return c=$(a.currentTarget),b.submit(c.text()),b.renderChoices(),b.renderChosen(),b.closeDropdown(),!1}),this.$input.on("focus",this.options.onFocus),this.$input.on("blur",this.options.onBlur)},a.prototype.submit=function(a){return this.store.isValid(a)?this.velge.addChosen({name:a}):!1},a.prototype.render=function(){return this.$wrapper=$(Velge.Util.template(this.wrapTemplate,this.options)),this.$inner=$(".velge-inner",this.$wrapper),this.$list=$(".velge-list",this.$wrapper),this.$input=$(".velge-input",this.$wrapper),this.$dropdown=$(".velge-dropdown",this.$wrapper),this.$container.append(this.$wrapper)},a.prototype.renderChosen=function(){var a,b;return b=function(){var b,c,d,e;for(d=this.store.filter({chosen:!0}),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(Velge.Util.template(this.chosenTemplate,{name:a.name}));return e}.call(this),this.$list.html(b)},a.prototype.renderChoices=function(a,b){var c,d;return a||(a=this.store.filter({chosen:!1})),d=function(){var d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(Velge.Util.template(this.choiceTemplate,{name:Velge.Util.emphasize(c.name,b)}));return f}.call(this),this.$dropdown.html(d)},a.prototype.renderHighlightedChoice=function(){var a,b,c,d,e,f,g,h;for(d=this.choiceIndex,g=this.$dropdown.find("li"),h=[],b=e=0,f=g.length;f>e;b=++e)c=g[b],a=$(c),a.toggleClass("highlighted",b===d),h.push(b===d?Velge.Util.autoScroll(a,this.$dropdown):void 0);return h},a.prototype.renderHighlightedChosen=function(){var a,b,c,d,e,f,g;for(c=this.chosenIndex,f=this.$list.find("li"),g=[],a=d=0,e=f.length;e>d;a=++d)b=f[a],g.push($(b).toggleClass("highlighted",a===c));return g},a.prototype.removeHighlightedChosen=function(){var a;return a=this.$list.find(".highlighted .name"),this.velge.remChosen({name:a.text()}),this.positionDropdown(this.options.dropdownOffset),this.chosenIndex=-1},a.prototype.cycleChoice=function(a){var b;return b=this.$dropdown.find("li").length,this.choiceIndex=Velge.Util.cycle(this.choiceIndex,b,a)},a.prototype.cycleChosen=function(a){var b;return b=this.$list.find("li").length,this.chosenIndex=Velge.Util.cycle(this.chosenIndex,b,a)},a.prototype.openDropdown=function(){return this.store.isEmpty()?void 0:(this.positionDropdown(this.options.dropdownOffset),this.$dropdown.addClass("open"))},a.prototype.positionDropdown=function(a){var b;return null==a&&(a=13),b=$(".velge-trigger",this.$container),this.$dropdown.css({top:b.outerHeight()+a})},a.prototype.closeDropdown=function(){return this.$dropdown.removeClass("open"),this.choiceIndex=-1,this.chosenIndex=-1},a.prototype.toggleDropdown=function(){return this.$dropdown.hasClass("open")?this.closeDropdown():this.openDropdown()},a.prototype.blurInput=function(){return""===this.$input.val()&&-1===this.choiceIndex&&-1===this.chosenIndex?this.$input.blur():void 0},a.prototype.clearInput=function(){return this.$input.val("")},a.prototype.filterChoices=function(a){var b;return b=this.store.fuzzy(a),this.renderChoices(b,a),0!==b.length?this.openDropdown():this.closeDropdown()},a.prototype.autoComplete=function(){var a;return a=this.$dropdown.find(".highlighted"),this.$input.val(a.text())},a}(),Velge.Store=function(){function a(a){null==a&&(a={}),this.arr=[],this.map={},this.options=Velge.Util.defaults(a,this.defaults)}return a.prototype.defaults={autoSort:!0},a.prototype.choices=function(){return this.arr},a.prototype.isEmpty=function(){return 0===this.arr.length},a.prototype.isValid=function(a){return!/^\s*$/.test(a)},a.prototype.push=function(a){return a.name=this._normalize(a.name),a.chosen||(a.chosen=!1),null==this.find(a)&&(this.arr.push(a),this.map[a.name]=a),this.options.autoSort&&this._sort(),this},a.prototype["delete"]=function(a){var b,c,d,e,f;for(f=this.arr,c=d=0,e=f.length;e>d;c=++d)if(b=f[c],b.name===a.name){this.arr.splice(c,1);break}return delete this.map[a.name]},a.prototype.update=function(a,b){var c,d,e,f;c=this.find(a),f=[];for(d in b)e=b[d],f.push(c[d]=e);return f},a.prototype.find=function(a){return this.map[this._normalize(a.name)]},a.prototype.fuzzy=function(a){var b,c,d,e,f,g,h;for(a=this._sanitize(a),c=/^\s*$/.test(a)?".*":a,d=RegExp(c,"i"),g=this.arr,h=[],e=0,f=g.length;f>e;e++)b=g[e],!b.chosen&&d.test(b.name)&&h.push(b);return h},a.prototype.filter=function(a){var b,c,d,e,f,g;for(c=a.chosen,c||(c=!1),f=this.arr,g=[],d=0,e=f.length;e>d;d++)b=f[d],b.chosen===c&&g.push(b);return g},a.prototype._normalize=function(a){return String(a).toLowerCase().replace(/(^\s*|\s*$)/g,"")},a.prototype._sanitize=function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&")},a.prototype._sort=function(){return this.arr.sort(function(a,b){return a.name>b.name?1:-1})},a}()}).call(this);