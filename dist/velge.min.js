!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Velge=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module){var bubble=_dereq_("./utils/bubble"),emitter=_dereq_("./utils/emitter"),merge=_dereq_("./utils/merge"),ChoiceStore=_dereq_("./stores/ChoiceStore"),Wrapper=_dereq_("./components/Wrapper"),Velge=function(element,options){options=options||{},this.element=element,this.store=new ChoiceStore(options),this.wrapper=new Wrapper(element,this.store),this._bubbleEvents(),this._preloadChoiceStore(options),this._render()};merge(Velge.prototype,emitter,bubble,{setOptions:function(options){options.comparator&&(this.store.comparator=options.comparator),options.limitation&&(this.store.limitation=options.limitation),this._render()},add:function(choice){return this.store.add(choice),this},choose:function(choice){return this.store.choose(choice),this},"delete":function(choice){return this.store.delete(choice),this},reject:function(choice){return this.store.reject(choice),this},getChoices:function(){return this.store.all()},getChosen:function(){return this.store.filter({chosen:!0})},_bubbleEvents:function(){this.bubble(this.wrapper,"blur"),this.bubble(this.wrapper,"focus"),this.bubble(this.store,"add"),this.bubble(this.store,"choose"),this.bubble(this.store,"delete"),this.bubble(this.store,"reject")},_preloadChoiceStore:function(options){var choices=options.choices||[],chosen=options.chosen||[];choices.forEach(function(choice){this.store.add(choice)},this),chosen.forEach(function(choice){this.store.choose(choice)},this)},_render:function(){this.wrapper.render()}}),module.exports=Velge},{"./components/Wrapper":5,"./stores/ChoiceStore":7,"./utils/bubble":8,"./utils/emitter":10,"./utils/merge":12}],2:[function(_dereq_,module){var emphasize=_dereq_("../utils/emphasize"),merge=_dereq_("../utils/merge"),emitter=_dereq_("../utils/emitter"),remove=_dereq_("../utils/remove_children"),Dropdown=function(){this.element=document.createElement("ol")},SELECT_EVENT="select";merge(Dropdown.prototype,emitter,{render:function(choices,options){return choices=choices||[],options=options||{},this._updateClassNames(choices,options.open),this._clearItems(),this._renderItems(choices,options),this._autoScroll(),this.element},handleClickName:function(name){this.emit(SELECT_EVENT,name)},_updateClassNames:function(choices,shouldOpen){var names=["velge-dropdown"];shouldOpen&&choices.length&&names.push("open"),this.element.className=names.join(" ")},_clearItems:function(){remove(this.element)},_renderItems:function(choices,options){var highlight=options.highlight,emphasis=options.emphasis;choices.forEach(function(name){var li=document.createElement("li");name===highlight&&(li.className="highlighted"),li.innerHTML=emphasize(name,emphasis),li.addEventListener("click",this.handleClickName.bind(this,name)),this.element.appendChild(li)},this)},_autoScroll:function(){var listElement=this._highlightedElement();if(listElement){var eHeight=listElement.offsetHeight,cHeight=this.element.offsetHeight,offset=listElement.offsetTop-this.element.offsetTop,scroll=this.element.scrollTop,baseTop=scroll+offset;0>offset?this.element.scrollTop=baseTop:offset+(eHeight>cHeight)&&(this.element.scrollTop=baseTop-cHeight+eHeight)}},_highlightedElement:function(){return this.element.querySelector("li.highlighted")}}),module.exports=Dropdown},{"../utils/emitter":10,"../utils/emphasize":11,"../utils/merge":12,"../utils/remove_children":13}],3:[function(_dereq_,module){var merge=_dereq_("../utils/merge"),emitter=_dereq_("../utils/emitter"),Input=function(){this.element=document.createElement("input"),this.rendered=!1},keycodes={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188},BLUR_EVENT="blur",CHANGE_EVENT="change",DELETE_EVENT="delete",ENTER_EVENT="enter",FOCUS_EVENT="focus",NAVIGATE_EVENT="navigate",INPUT_DELAY=5,BLUR_DELAY=100;merge(Input.prototype,emitter,{render:function(value){return this._renderElement(),value&&(this.element.value=value),this.element},clear:function(){this.element.value=""},handleKeydown:function(event){switch(event.keyCode){case keycodes.ESCAPE:event.stopPropagation(),this.emit(BLUR_EVENT),this.clear();break;case keycodes.ENTER:event.preventDefault(),this._emitEnter(),this.clear();break;case keycodes.COMMA:event.preventDefault(),this._emitEnter();break;case keycodes.LEFT:this._isBlank()&&this._emitNavigate("left");break;case keycodes.UP:event.preventDefault(),this._emitNavigate("up");break;case keycodes.RIGHT:this._isBlank()&&this._emitNavigate("right");break;case keycodes.DOWN:event.preventDefault(),this._emitNavigate("down");break;case keycodes.TAB:event.preventDefault(),this._emitNavigate("down");break;case keycodes.BACKSPACE:this._isBlank()&&this.emit(DELETE_EVENT);break;default:setTimeout(this._emitChange.bind(this),INPUT_DELAY)}},handleBlur:function(){var self=this;setTimeout(function(){self.emit(BLUR_EVENT)},BLUR_DELAY)},handleFocus:function(){this.emit(FOCUS_EVENT)},_renderElement:function(){this.rendered||(this.element.type="text",this.element.attributes.autocomplete="off",this.element.placeholder="Add",this.element.className="velge-input",this.element.addEventListener("blur",this.handleBlur.bind(this)),this.element.addEventListener("focus",this.handleFocus.bind(this)),this.element.addEventListener("keydown",this.handleKeydown.bind(this)),this.rendered=!0)},_isBlank:function(){return""===this.element.value},_emitEnter:function(){var value=this.element.value;value&&""!==value&&(this.clear(),this.emit(ENTER_EVENT,value))},_emitChange:function(){this.emit(CHANGE_EVENT,this.element.value)},_emitNavigate:function(direction){this.emit(NAVIGATE_EVENT,direction)}}),module.exports=Input},{"../utils/emitter":10,"../utils/merge":12}],4:[function(_dereq_,module){var merge=_dereq_("../utils/merge"),emitter=_dereq_("../utils/emitter"),remove=_dereq_("../utils/remove_children"),List=function(){this.element=document.createElement("ul")},REMOVE_EVENT="remove";merge(List.prototype,emitter,{render:function(chosen,options){return options=options||{},chosen=chosen||[],this.element.className="velge-list",this._clearItems(),this._renderItems(chosen,options),this.element},handleClickRemove:function(name){this.emit(REMOVE_EVENT,name)},_clearItems:function(){remove(this.element)},_renderItems:function(chosen,options){var highlight=options.highlight;chosen.forEach(function(name){var li=document.createElement("li"),span=document.createElement("span"),rem=document.createElement("span");name===highlight&&(li.className="highlighted"),span.className="name",span.textContent=name,rem.className="remove",rem.innerHTML="&times;",rem.addEventListener("click",this.handleClickRemove.bind(this,name)),li.appendChild(span),li.appendChild(rem),this.element.appendChild(li)},this)}}),module.exports=List},{"../utils/emitter":10,"../utils/merge":12,"../utils/remove_children":13}],5:[function(_dereq_,module){var cycle=_dereq_("../utils/cycle"),emitter=_dereq_("../utils/emitter"),merge=_dereq_("../utils/merge"),Dropdown=_dereq_("./Dropdown"),Input=_dereq_("./Input"),List=_dereq_("./List"),Wrapper=function(parent,store){this.parent=parent,this.store=store,this.state=merge({},this.defaultState),this.store.on("change",this.render.bind(this))};merge(Wrapper.prototype,emitter,{defaultState:{hIndex:-1,vIndex:-1,query:null,open:!1},render:function(){return this._renderElement(),this._renderDropdown(),this._renderList(),this._renderInput(),this.element},setState:function(props){merge(this.state,props),this.render()},handleDropdownSelect:function(value){this.store.choose({name:value}),this.setState({vIndex:-1,query:null,open:!1})},handleInputEnter:function(value){this.store.choose({name:value}),this.setState({hIndex:-1,vIndex:-1,query:null,open:!1})},handleInputDelete:function(){var name=this.store.chosenNames()[this.state.hIndex];this.store.reject({name:name}),this.setState({hIndex:-1})},handleInputBlur:function(){this.emit("blur"),this.setState({hIndex:-1,vIndex:-1,query:null,open:!1})},handleInputChange:function(value){this.setState({query:value,open:!0})},handleInputFocus:function(){this.emit("focus")},handleInputNavigate:function(direction){switch(direction){case"down":this.setState({vIndex:this._cycleChoice("down"),open:!0});break;case"up":this.setState({vIndex:this._cycleChoice("up"),open:!0});break;case"left":this.setState({hIndex:this._cycleChosen("up")});break;case"right":this.setState({hIndex:this._cycleChosen("down")})}},handleListRemove:function(value){this.store.reject({name:value})},handleTriggerClick:function(){this.setState({open:!this.state.open})},_renderElement:function(){this.element||(this.element=document.createElement("div"),this.element.className="velge",this.parent.appendChild(this.element),this.inner=document.createElement("div"),this.inner.className="velge-inner",this.element.appendChild(this.inner),this.trigger=document.createElement("span"),this.trigger.className="velge-trigger",this.inner.appendChild(this.trigger),this.trigger.addEventListener("click",this.handleTriggerClick.bind(this)))},_renderDropdown:function(){this.dropdown||(this.dropdown=new Dropdown,this.element.appendChild(this.dropdown.element),this.dropdown.on("select",this.handleDropdownSelect.bind(this))),this.dropdown.render(this._currentChoices(),{emphasis:this.state.query,highlight:this._currentSelection(),open:this.state.open})},_renderList:function(){var chosen=this.store.chosenNames();this.list||(this.list=new List,this.inner.appendChild(this.list.element),this.list.on("remove",this.handleListRemove.bind(this))),this.list.render(chosen,{highlight:chosen[this.state.hIndex]})},_renderInput:function(){this.input||(this.input=new Input,this.inner.appendChild(this.input.element),this.input.on("blur",this.handleInputBlur.bind(this)),this.input.on("change",this.handleInputChange.bind(this)),this.input.on("delete",this.handleInputDelete.bind(this)),this.input.on("enter",this.handleInputEnter.bind(this)),this.input.on("focus",this.handleInputFocus.bind(this)),this.input.on("navigate",this.handleInputNavigate.bind(this))),this.input.render(this._currentSelection())},_currentChoices:function(){var query=this.state.query;return query?this.store.fuzzy(query):this.store.choiceNames()},_currentSelection:function(){var index=this.state.vIndex,choices=this._currentChoices();return choices[index]},_cycleChoice:function(direction){var length=this._currentChoices().length;return cycle(this.state.vIndex,length,direction)},_cycleChosen:function(direction){var length=this.store.chosenNames().length;return cycle(this.state.hIndex,length,direction)}}),module.exports=Wrapper},{"../utils/cycle":9,"../utils/emitter":10,"../utils/merge":12,"./Dropdown":2,"./Input":3,"./List":4}],6:[function(_dereq_,module){module.exports=_dereq_("./Velge")},{"./Velge":1}],7:[function(_dereq_,module){var emitter=_dereq_("../utils/emitter"),merge=_dereq_("../utils/merge"),ChoiceStore=function(options){options=options||{},this.comparator=options.comparator,this.limitation=options.limitation,this.objects={}},ADD_EVENT="add",CHANGE_EVENT="change",CHOOSE_EVENT="choose",DELETE_EVENT="delete",REJECT_EVENT="reject";merge(ChoiceStore.prototype,emitter,{isValid:function(value){return!/^\s*$/.test(value)},has:function(object){return!!this.objects[this._normalize(object.name)]},add:function(object){return this._add(object),this.emit(ADD_EVENT,object),this.emit(CHANGE_EVENT),this},choose:function(object){return this.has(object)||this._add(object),this.limitation&&this.rejectAll(),this._update(object,!0),this},reject:function(object){return this._update(object,!1),this},rejectAll:function(){this.all().forEach(function(object){this._update(object,!1)},this)},"delete":function(object){return delete this.objects[this._normalize(object.name)],this.emit(DELETE_EVENT,object),this.emit(CHANGE_EVENT),this},all:function(){var objects=this.objects,mapped=Object.keys(objects).map(function(key){return objects[key]});return this.comparator&&(mapped=mapped.sort(this.comparator)),mapped},allNames:function(){return this.all().map(function(object){return object.name})},choiceNames:function(){return this._filteredNames(!1)},chosenNames:function(){return this._filteredNames(!0)},filter:function(criteria){return this.all().filter(function(object){return object.chosen===criteria.chosen})},fuzzy:function(value){var sanitized=this._sanitize(value),query=/^\s*$/.test(sanitized)?".*":sanitized,regex=RegExp(query,"i");return this.allNames().filter(function(name){return regex.test(name)})},_add:function(object){object.chosen=!1,object.name=this._normalize(object.name),this.objects[object.name]=object},_update:function(object,chosen){var original=this.objects[this._normalize(object.name)],event=chosen?CHOOSE_EVENT:REJECT_EVENT;original&&(original.chosen=chosen,this.emit(event,original),this.emit(CHANGE_EVENT))},_filteredNames:function(chosen){return this.filter({chosen:chosen}).map(function(object){return object.name})},_normalize:function(value){return String(value).toLowerCase().replace(/(^\s*|\s*$)/g,"")},_sanitize:function(value){return value.replace(/[-[\]{}()*+?.,\\^$|#]/g,"\\$&")}}),module.exports=ChoiceStore},{"../utils/emitter":10,"../utils/merge":12}],8:[function(_dereq_,module){module.exports={bubble:function(emitter,event){emitter.on(event,this.emit.bind(this,event))}}},{}],9:[function(_dereq_,module){module.exports=function(index,length,direction){return 1>length?-1:("up"===direction&&-1===index&&(index=0),"down"===direction?(index+1)%length:(index+(length-1))%length)}},{}],10:[function(_dereq_,module){module.exports={on:function(name,callback,context){this._events=this._events||{};var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context||this}),this},off:function(name,callback,context){var events=this._events[name];return callback||context||delete this._events[name],this._events[name]=events.filter(function(event){return callback&&callback!==event.callback||context&&context!==event.context}),this},emit:function(name){if(!this._events)return this;var args=[].slice.call(arguments,1),events=this._events[name];return events&&events.forEach(function(event){event.callback.apply(event.context,args)}),this}}},{}],11:[function(_dereq_,module){module.exports=function(string,pattern){var regex=new RegExp("("+pattern+")","i");return string.replace(regex,"<b>$1</b>")}},{}],12:[function(_dereq_,module){module.exports=function(object){return[].slice.call(arguments,1).forEach(function(source){for(var prop in source)object[prop]=source[prop]}),object}},{}],13:[function(_dereq_,module){module.exports=function(element){for(var child=element.firstChild;child;)element.removeChild(child),child=element.firstChild}},{}]},{},[6])(6)});